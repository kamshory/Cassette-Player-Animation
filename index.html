<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" data-logged-in="true">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="shortcut icon" type="image/jpeg" href="favicon.png" />
<title>Cassette Player Animation</title>
</head>
<body>
<div class="all">


<div class="cassete">
	<canvas id="canvas" width="586" height="379"></canvas>
</div>

<div id="status"></div>

</div>
<script type="text/javascript">

var startTime = (new Date()).getTime();
var currentPos = 0;
var angel1 = 0;
var angel2 = 0;
var img1 = new Image();
img1.src = 'img/cs_wheel.png';

var img2 = new Image();
img2.src = 'img/cs_back.png';

var img3 = new Image();
img3.src = 'img/cs_front.png';

function play()
{
	currentPos = 0;
	draw();
}
var totalLength = 2700;
var maxDuration = 2700;

var cassette = new Cassette(totalLength, maxDuration);

function imageRotate(image, angle)
{
	var degrees = 180 * angle / Math.acos(-1);
	var canv = document.createElement('canvas');
	canv.width = image.width;
	canv.height = image.height;
	var ctx = canv.getContext('2d');
	ctx.clearRect(0,0,canv.width,canv.height);
	ctx.save();
	ctx.translate(canv.width/2,canv.height/2);
	ctx.rotate(degrees*Math.PI/180);
	ctx.drawImage(image,-image.width/2,-image.width/2);
	ctx.restore();
		
	return canv;
}

function draw()
{
	var scale = 47;
	var currentTime = (new Date()).getTime();
	currentPos = (currentTime - startTime)/1000;

	cassette.reel1.drawReel(currentPos);
	cassette.reel2.drawReel(currentPos);

	var canvas = document.querySelector('#canvas');
	var context = canvas.getContext('2d');
	
	context.clearRect(0, 0, canvas.width, canvas.height);

	context.drawImage(img2, 0, 0);
	
	var point1 = {x:412, y:170};
	var point2 = {x:172, y:170};
	
	
	context.beginPath();
	context.arc(point1.x, point1.y, cassette.reel1.radius * scale, 0, 2 * Math.PI, false);
	context.fillStyle = '#111111';
	context.fill();
	context.lineWidth = 1;
	context.strokeStyle = '#111111';
	context.stroke();
	
	context.beginPath();
	context.arc(point2.x, point2.y, cassette.reel2.radius * scale, 0, 2 * Math.PI, false);
	context.fillStyle = '#111111';
	context.fill();
	context.lineWidth = 1;
	context.strokeStyle = '#111111';
	context.stroke();
	
	context.globalCompositeOperation = "destination-out";

	context.beginPath();
	context.arc(point1.x, point1.y, 62, 0, 2 * Math.PI, false);
	context.fillStyle = '#FFFFFF';
	context.fill();
	context.lineWidth = 1;
	context.strokeStyle = '#FFFFFF';
	context.stroke();
	
	context.beginPath();
	context.arc(point2.x, point2.y, 62, 0, 2 * Math.PI, false);
	context.fillStyle = '#FFFFFF';
	context.fill();
	context.lineWidth = 1;
	context.strokeStyle = '#FFFFFF';
	context.stroke();
	
	context.globalCompositeOperation = "source-over";
	
	var point3 = {x:552, y:300};
	var point4 = {x:34, y:300};

	context.drawImage(imageRotate(img1, cassette.reel1.angle), point1.x - 62, point1.y - 62);
	context.drawImage(imageRotate(img1, cassette.reel2.angle), point2.x - 62, point2.y - 62);
	
	
	context.lineWidth = 1;
	context.strokeStyle = "#ff0000";
	
	var point5 = getPont(1, point1, point3, cassette.reel1.radius * scale);
	var point6 = getPont(2, point2, point4, cassette.reel2.radius * scale);

	context.lineWidth = 1;
	context.strokeStyle = "#444444";

	context.beginPath();
	context.moveTo(point4.x, point4.y);
	context.lineTo(point6.x, point6.y);
	context.stroke();
	
	context.lineWidth = 1;
	context.strokeStyle = "#444444";

	context.beginPath();
	context.moveTo(point3.x, point3.y);
	context.lineTo(point5.x, point5.y);
	context.stroke();
	
	
	context.drawImage(img3, 0, 0);
	
	if(currentPos < maxDuration)
	{
		window.requestAnimationFrame(draw);
	}
}

function getDistance(point1, point2)
{
	return Math.sqrt(
		((point1.x - point2.x) * (point1.x - point2.x))
		+
		((point1.y - point2.y) * (point1.y - point2.y))		
		);
}
function getSide(distance1, distance2)
{
	return Math.sqrt(
		((distance1) * (distance1))
		-
		((distance2) * (distance2))		
		);
}
function contraGradient(point1, point2)
{
	return (point1.y - point2.y) / (point1.x - point2.x);
}
function getPont(label, point1, point2, radius)
{
	var distance = getDistance(point1, point2);
	var side = getSide(distance, radius);
	
	var gradient = contraGradient(point1, point2);
	var angle = Math.atan(gradient);
	
	var angle2 = Math.asin(side/distance);
	
	if(label == 1)
	{
		var angle3 = angle + angle2 - (Math.PI/2);
		
		var x = Math.cos(angle3) * radius;
		var y = Math.sin(angle3) * radius;
		var point = {x: point1.x + x, y:point1.y - y};
	}
	if(label == 2)
	{
		var angle3 = (Math.PI/2) + angle - angle2;
		
		var x = Math.cos(angle3) * radius;
		var y = Math.sin(angle3) * radius;
		var point = {x: point1.x - x, y:point1.y + y};
	}
	return point;
}
function Cassette(duration, maxDuration)
{
	this.duration = duration; // Seconds
	this.maxDuration = maxDuration;
	this.position = 0; // Seconds
	this.tapeLength = duration * 15 / 4; // Centimeters
	this.tapeThickness = 0.00026;
	this.reelRadius = 1.4;
	
	this.reel1 = new Rheel(1, this.duration, this.maxDuration, this.tapeLength, this.tapeThickness, this.reelRadius);
	this.reel2 = new Rheel(2, this.duration, this.maxDuration, this.tapeLength, this.tapeThickness, this.reelRadius);	
	
}

function Rheel(label, duration, maxDuration, tapeLength, tapeThickness, reelRadius)
{
	this.label = label;
	this.duration = duration;
	this.maxDuration = maxDuration;
	this.tapeLength = tapeLength;
	this.tapeThickness = tapeThickness;
	this.reelRadius = reelRadius;
	this.angle = 0;
	this.delta = 0;
	this.angularSpeed = 0;
	this.drawReel = function(position)
	{
		var linearSpeed = 15/4;
		if(label == 1)
		{
			this.delta = this.getDelta(position);
			this.radius = reelRadius + this.delta;
		}
		if(label == 2)
		{
			this.delta = this.getDelta(this.duration) - this.getDelta(position);
			this.radius = reelRadius + this.delta;
		}
		var circumference = Math.acos(-1) * 2 * (this.radius);
		this.angularSpeed = 0.12 * (Math.acos(-1) * 2) / circumference;
		this.angle -= this.angularSpeed;
	}
	this.getDelta = function(position)
	{
		if(position > duration)
		{
			position = duration;
		}
		var linearSpeed = 15/4;
		var circumference = Math.acos(-1) * 2 * (reelRadius);
		var delta = this.tapeThickness * circumference * position * 2700 / (linearSpeed * this.maxDuration);
		return delta;
	}
}

play();
</script>

</body>
</html>
